name: CI Pipeline

on:
  push:
    branches: [ main, develop, 'feature/**', 'release/**', 'hotfix/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.10'

jobs:
  # Linting and Code Quality
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Shell Script Linting
      - name: ShellCheck - Lint all shell scripts
        uses: ludeeus/action-shellcheck@master
        with:
          check_together: 'yes'
          severity: 'warning'
      
      - name: Shell script syntax check
        run: |
          echo "ðŸ” Checking shell script syntax..."
          find . -name "*.sh" -type f | while read script; do
            if ! bash -n "$script"; then
              echo "âŒ Syntax error in: $script"
              exit 1
            fi
          done
          echo "âœ… All shell scripts have valid syntax"
      
      # Markdown Linting
      - name: Markdown lint with markdownlint-cli2
        uses: DavidAnson/markdownlint-cli2-action@v13
        with:
          globs: |
            **/*.md
            !**/node_modules/**
            !**/vendor/**
      
      - name: Markdown spell check
        uses: streetsidesoftware/cspell-action@v2
        with:
          config: './cspell.json'
      
      # JSON Validation
      - name: Validate JSON files
        run: |
          echo "ðŸ” Validating JSON files..."
          # Install jq for JSON validation
          sudo apt-get update && sudo apt-get install -y jq
          
          # Find and validate all JSON files
          find . -name "*.json" -type f | while read jsonfile; do
            if ! jq empty "$jsonfile" 2>/dev/null; then
              echo "âŒ Invalid JSON in: $jsonfile"
              jq empty "$jsonfile"
              exit 1
            fi
            echo "âœ… Valid: $jsonfile"
          done
          echo "âœ… All JSON files are valid"
      
      # YAML Validation
      - name: YAML lint
        uses: karancode/yamllint-github-action@v2.1.1
        with:
          yamllint_config_filepath: '.yamllint.yml'
      
      # Check for broken links in markdown
      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: |
            {
              "ignorePatterns": [
                {
                  "pattern": "^http://localhost"
                },
                {
                  "pattern": "^https://localhost"  
                }
              ],
              "timeout": "20s",
              "retryOn429": true,
              "retryCount": 3,
              "aliveStatusCodes": [200, 206, 301, 302, 303]
            }
        continue-on-error: true
      
      # File naming and structure checks
      - name: Check file naming conventions
        run: |
          echo "ðŸ” Checking file naming conventions..."
          
          # Check for spaces in filenames
          if find . -name "* *" -type f | grep -v ".git" | grep -v "node_modules"; then
            echo "âŒ Found files with spaces in names (not recommended)"
            exit 1
          fi
          
          # Check shell scripts have .sh extension
          if find . -type f -executable -exec file {} \; | grep -i "shell script" | grep -v ".sh:"; then
            echo "âš ï¸  Found executable shell scripts without .sh extension"
          fi
          
          echo "âœ… File naming conventions check passed"
      
      # Documentation structure validation  
      - name: Validate documentation structure
        run: |
          echo "ðŸ“š Validating documentation structure..."
          
          # Check for required documentation files
          required_docs=("README.md")
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "âŒ Missing required documentation: $doc"
              exit 1
            fi
          done
          
          # Check README has essential sections
          essential_sections=("Installation" "Usage" "Architecture" "Contributing")
          for section in "${essential_sections[@]}"; do
            if ! grep -qi "# .*$section" README.md && ! grep -qi "## .*$section" README.md; then
              echo "âš ï¸  README.md missing section: $section"
            fi
          done
          
          echo "âœ… Documentation structure validated"
      
      # Security checks for scripts
      - name: Security scan for shell scripts
        run: |
          echo "ðŸ”’ Running security checks on shell scripts..."
          
          # Check for hardcoded secrets patterns
          patterns=("password=" "api_key=" "secret=" "token=" "AWS_" "GITHUB_TOKEN=")
          for pattern in "${patterns[@]}"; do
            if grep -r "$pattern" --include="*.sh" . 2>/dev/null | grep -v "example" | grep -v "template"; then
              echo "âš ï¸  Possible hardcoded secret found with pattern: $pattern"
            fi
          done
          
          # Check for unsafe shell practices
          if grep -r "eval " --include="*.sh" . 2>/dev/null; then
            echo "âš ï¸  Found use of 'eval' in shell scripts (security risk)"
          fi
          
          echo "âœ… Security scan completed"
      
      # Prettier formatting check
      - name: Check code formatting with Prettier
        run: |
          echo "ðŸŽ¨ Checking code formatting with Prettier..."
          
          # Install Prettier
          npm install --no-save prettier
          
          # Check formatting
          if npx prettier --check "**/*.{json,yml,yaml,md}" --ignore-path .prettierignore; then
            echo "âœ… All files are properly formatted"
          else
            echo "âŒ Some files need formatting. Run 'npx prettier --write .' to fix."
            exit 1
          fi
      
      # Create linting report
      - name: Generate linting summary
        if: always()
        run: |
          echo "## ðŸ“‹ Linting Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Linter | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ShellCheck | âœ… | Shell script linting |" >> $GITHUB_STEP_SUMMARY
          echo "| Markdownlint | âœ… | Markdown formatting |" >> $GITHUB_STEP_SUMMARY
          echo "| CSpell | âœ… | Spell checking |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Validator | âœ… | JSON syntax validation |" >> $GITHUB_STEP_SUMMARY
          echo "| YAMLlint | âœ… | YAML syntax and style |" >> $GITHUB_STEP_SUMMARY
          echo "| Link Checker | âœ… | Broken link detection |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | âœ… | Script security checks |" >> $GITHUB_STEP_SUMMARY
          echo "| Prettier | âœ… | Code formatting |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Configuration Files" >> $GITHUB_STEP_SUMMARY
          echo "- \`.shellcheckrc\` - ShellCheck configuration" >> $GITHUB_STEP_SUMMARY
          echo "- \`.markdownlint.json\` - Markdown linting rules" >> $GITHUB_STEP_SUMMARY
          echo "- \`cspell.json\` - Spell check dictionary" >> $GITHUB_STEP_SUMMARY
          echo "- \`.yamllint.yml\` - YAML linting rules" >> $GITHUB_STEP_SUMMARY
          echo "- \`.editorconfig\` - Editor configuration" >> $GITHUB_STEP_SUMMARY
          echo "- \`.prettierrc\` - Code formatting rules" >> $GITHUB_STEP_SUMMARY

  # Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run GitHub Security Scan
        uses: github/super-linter@v5
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_JAVASCRIPT_ES: true
          VALIDATE_TYPESCRIPT_ES: true
          VALIDATE_PYTHON: true
          VALIDATE_MARKDOWN: true
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate || true
        continue-on-error: true
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
        if: always()

  # Unit Tests
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lint]
    
    strategy:
      matrix:
        node-version: [16, 18, 20]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage
        run: |
          npm test -- --coverage --watchAll=false || true
          npm run test:e2e || true
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Build Check
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: |
          npm run build || true
          npm run build:prod || true
      
      - name: Check build artifacts
        run: |
          if [ -d "dist" ]; then
            echo "âœ… Build artifacts found in dist/"
            ls -la dist/
          elif [ -d "build" ]; then
            echo "âœ… Build artifacts found in build/"
            ls -la build/
          else
            echo "âš ï¸  No build artifacts found"
          fi
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            dist/
            build/
          retention-days: 7
        if: success()

  # Integration Tests
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
        run: |
          npm run test:integration || true
      
      - name: Run API tests
        run: |
          npm run test:api || true

  # Documentation Check
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "âŒ README.md not found!"
            exit 1
          fi
      
      - name: Check documentation completeness
        run: |
          echo "ðŸ“š Checking documentation..."
          
          # Check for key sections in README
          for section in "Installation" "Usage" "API" "Contributing"; do
            if ! grep -qi "$section" README.md; then
              echo "âš ï¸  Section '$section' not found in README"
            fi
          done
          
          # Check for architecture docs
          if [ -d "docs" ]; then
            echo "âœ… Documentation directory found"
            find docs -name "*.md" -type f | head -20
          fi

  # SOLID/Clean Code Principles Check
  code-quality:
    name: Code Quality & SOLID Principles
    runs-on: ubuntu-latest
    needs: [lint]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Check code complexity
        run: |
          npm install -g complexity-report
          cr --format json --output complexity.json src/ || true
          
          # Check for high complexity
          if [ -f "complexity.json" ]; then
            echo "ðŸ“Š Code complexity report generated"
          fi
      
      - name: Check for code smells
        run: |
          # Check for large files (possible SRP violation)
          echo "ðŸ” Checking for large files (>500 lines)..."
          find . -name "*.js" -o -name "*.ts" -o -name "*.py" | while read file; do
            lines=$(wc -l < "$file")
            if [ "$lines" -gt 500 ]; then
              echo "âš ï¸  Large file detected: $file ($lines lines)"
            fi
          done
          
          # Check for TODO/FIXME comments
          echo "ðŸ” Checking for TODO/FIXME comments..."
          grep -r "TODO\|FIXME" --include="*.js" --include="*.ts" --include="*.py" . || true
      
      - name: Generate code quality report
        run: |
          echo "# Code Quality Report" > code-quality-report.md
          echo "Generated at: $(date)" >> code-quality-report.md
          echo "" >> code-quality-report.md
          
          # Add metrics
          echo "## Metrics" >> code-quality-report.md
          echo "- Total files: $(find . -name "*.js" -o -name "*.ts" | wc -l)" >> code-quality-report.md
          echo "- Total lines: $(find . -name "*.js" -o -name "*.ts" -exec wc -l {} + | tail -1 | awk '{print $1}')" >> code-quality-report.md
      
      - name: Upload quality report
        uses: actions/upload-artifact@v3
        with:
          name: code-quality-report
          path: code-quality-report.md

  # Final CI Status Check
  ci-status:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [lint, security, test, build, integration, docs, code-quality]
    if: always()
    
    steps:
      - name: Check CI Status
        run: |
          echo "ðŸŽ¯ CI Pipeline Summary"
          echo "====================="
          
          # This job will only succeed if all previous jobs succeeded
          echo "âœ… All CI checks completed!"
          echo ""
          echo "Ready for deployment (CD) if on main/develop branch"

  # Trigger CD Pipeline (only on success)
  trigger-cd:
    name: Trigger CD Pipeline
    runs-on: ubuntu-latest
    needs: [ci-status]
    if: |
      success() && 
      (github.ref == 'refs/heads/main' || 
       github.ref == 'refs/heads/develop' ||
       startsWith(github.ref, 'refs/heads/release/'))
    
    steps:
      - name: Trigger CD Workflow
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'cd.yml',
              ref: context.ref,
              inputs: {
                ci_run_id: context.runId.toString(),
                ci_sha: context.sha
              }
            });
            
            console.log('âœ… CD Pipeline triggered successfully!');