#!/bin/bash

# Post-flow-feature-finish hook: Update task status and cleanup

FEATURE_NAME=$1
FEATURE_BRANCH="feature/$FEATURE_NAME"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "\n${GREEN}âœ… Finishing feature: ${YELLOW}$FEATURE_NAME${NC}"

# Check for linked task
if [ -f ".claude/current-task.txt" ]; then
    TASK_NUMBER=$(cat .claude/current-task.txt)
    echo -e "${BLUE}Found linked task: #$TASK_NUMBER${NC}"
    
    # Update task status to Done (this will generate completion report)
    echo -e "${BLUE}Updating task status to Done and generating completion report...${NC}"
    ./tools/github-project-management/utilities/update-task-status.sh "$TASK_NUMBER" "Done" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… Task #$TASK_NUMBER marked as Done${NC}"
        echo -e "${GREEN}âœ… Completion report added to task${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Could not update task status. Please update manually.${NC}"
        echo -e "${BLUE}To update manually: ${GREEN}git task-status $TASK_NUMBER Done${NC}"
    fi
    
    # Check for open PR
    echo -e "\n${BLUE}Checking for pull requests...${NC}"
    OPEN_PRS=$(gh pr list --head "$FEATURE_BRANCH" --state open --json number,title)
    
    if [ -n "$OPEN_PRS" ] && [ "$OPEN_PRS" != "[]" ]; then
        echo -e "${YELLOW}âš ï¸  Found open pull request(s):${NC}"
        echo "$OPEN_PRS" | jq -r '.[] | "  PR #\(.number): \(.title)"'
        echo -e "${RED}Remember to merge or close the PR!${NC}"
    fi
else
    echo -e "${YELLOW}âš ï¸  No task was linked to this feature${NC}"
fi

# Get feature statistics
if [ -f ".claude/gitflow-status.env" ]; then
    source .claude/gitflow-status.env
    
    echo -e "\n${PURPLE}ðŸ“Š Feature Statistics:${NC}"
    echo -e "  Started: $GITFLOW_STARTED_AT"
    echo -e "  Commits: $GITFLOW_COMMIT_COUNT"
    
    # Calculate duration
    if [ -n "$GITFLOW_STARTED_AT" ]; then
        START_TS=$(date -j -f "%Y-%m-%dT%H:%M:%SZ" "$GITFLOW_STARTED_AT" +%s 2>/dev/null || date -d "$GITFLOW_STARTED_AT" +%s 2>/dev/null)
        END_TS=$(date +%s)
        DURATION_SECONDS=$((END_TS - START_TS))
        DURATION_HOURS=$((DURATION_SECONDS / 3600))
        DURATION_DAYS=$((DURATION_HOURS / 24))
        
        if [ $DURATION_DAYS -gt 0 ]; then
            echo -e "  Duration: ${YELLOW}$DURATION_DAYS days${NC}"
        else
            echo -e "  Duration: ${YELLOW}$DURATION_HOURS hours${NC}"
        fi
    fi
    
    # Archive feature data
    ARCHIVE_DIR=".claude/archived-features"
    mkdir -p "$ARCHIVE_DIR"
    
    # Create archive entry
    cat > "$ARCHIVE_DIR/feature-$FEATURE_NAME-$(date +%Y%m%d-%H%M%S).json" << EOF
{
  "feature_name": "$FEATURE_NAME",
  "branch": "$FEATURE_BRANCH",
  "started_at": "$GITFLOW_STARTED_AT",
  "finished_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "commit_count": $GITFLOW_COMMIT_COUNT,
  "linked_task": "$(cat .claude/current-task.txt 2>/dev/null || echo 'none')",
  "description": "$FEATURE_DESCRIPTION"
}
EOF
    
    echo -e "${GREEN}âœ… Feature data archived${NC}"
fi

# Cleanup tracking files
echo -e "\n${BLUE}Cleaning up tracking files...${NC}"
rm -f .claude/current-task.txt
rm -f .claude/gitflow-status.env
rm -f .claude/feature-plan-$FEATURE_NAME.md

# Create completion summary
cat > .claude/last-feature-summary.md << EOF
# Feature Completion Summary

## Feature: $FEATURE_NAME
- **Branch**: $FEATURE_BRANCH
- **Completed**: $(date)
- **Task**: #$(cat .claude/current-task.txt 2>/dev/null || echo "Not linked")

## Next Steps
1. Review merged changes in develop branch
2. Consider creating a release if feature set is complete
3. Pick next task: \`git next\` or \`./tools/github-project-management/utilities/get-next-kanban-item.sh\`

## Start New Feature
\`\`\`bash
git flow feature start <new-feature-name>
\`\`\`
EOF

echo -e "\n${GREEN}ðŸŽ‰ Feature '$FEATURE_NAME' completed successfully!${NC}"
echo -e "\n${PURPLE}ðŸ“Œ What's Next:${NC}"
echo -e "  1. ${BLUE}Review changes${NC} in develop branch"
echo -e "  2. ${BLUE}Get next task:${NC} ${GREEN}git next${NC}"
echo -e "  3. ${BLUE}Start new feature:${NC} ${GREEN}git flow feature start <name>${NC}"
echo -e "  4. ${BLUE}Create release:${NC} ${GREEN}git flow release start <version>${NC}"

# Play completion sound if available
if command -v afplay &> /dev/null; then
    afplay /System/Library/Sounds/Glass.aiff 2>/dev/null || true
elif command -v paplay &> /dev/null; then
    paplay /usr/share/sounds/freedesktop/stereo/complete.oga 2>/dev/null || true
fi

echo -e "\n${GREEN}Great work! ðŸš€${NC}\n"