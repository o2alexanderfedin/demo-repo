#!/bin/bash

# Post-checkout hook: Enhanced with GitFlow enforcement

# Only run on branch switch (not file checkout)
if [ "$3" = "1" ]; then
    # Colors
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    PURPLE='\033[0;35m'
    RED='\033[0;31m'
    NC='\033[0m'
    
    # Get branch names
    OLD_BRANCH=$(git name-rev --name-only $1 2>/dev/null | sed 's/remotes\/origin\///')
    NEW_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)
    
    echo -e "\n${GREEN}‚úÖ Switched from ${YELLOW}$OLD_BRANCH${GREEN} to ${YELLOW}$NEW_BRANCH${NC}"
    
    # Check if switching to protected branch
    if [[ "$NEW_BRANCH" == "main" ]] || [[ "$NEW_BRANCH" == "master" ]]; then
        echo -e "\n${RED}‚ö†Ô∏è  WARNING: You are on the MAIN branch!${NC}"
        echo -e "${YELLOW}Direct commits are not allowed. Only merge commits from:${NC}"
        echo -e "  ‚Ä¢ Release branches (via ${GREEN}git flow release finish${NC})"
        echo -e "  ‚Ä¢ Hotfix branches (via ${GREEN}git flow hotfix finish${NC})"
        echo -e "\n${BLUE}To start work:${NC}"
        echo -e "  ‚Ä¢ Hotfix: ${GREEN}git flow hotfix start <version>${NC}"
        echo -e "  ‚Ä¢ Feature: ${GREEN}git checkout develop && git flow feature start <name>${NC}"
        
    elif [[ "$NEW_BRANCH" == "develop" ]]; then
        echo -e "\n${BLUE}üìå On develop branch${NC}"
        echo -e "${YELLOW}Direct commits are discouraged. Use feature branches:${NC}"
        echo -e "  ‚Ä¢ ${GREEN}git flow feature start <name>${NC}"
        echo -e "\n${BLUE}Available actions:${NC}"
        echo -e "  ‚Ä¢ Start feature: ${GREEN}git flow feature start <name>${NC}"
        echo -e "  ‚Ä¢ Start release: ${GREEN}git flow release start <version>${NC}"
        echo -e "  ‚Ä¢ View features: ${GREEN}git flow feature list${NC}"
        
        # Show recent features
        RECENT_FEATURES=$(git branch -a | grep "feature/" | head -5)
        if [ -n "$RECENT_FEATURES" ]; then
            echo -e "\n${BLUE}Recent features:${NC}"
            echo "$RECENT_FEATURES" | sed 's/^/  /'
        fi
        
    elif [[ "$NEW_BRANCH" =~ ^feature/ ]]; then
        FEATURE_NAME=${NEW_BRANCH#feature/}
        echo -e "üåø Now on feature: ${YELLOW}$FEATURE_NAME${NC}"
        
        # Check for linked task
        if [ -f ".claude/current-task.txt" ]; then
            TASK_NUMBER=$(cat .claude/current-task.txt)
            echo -e "üìå Linked to task: ${GREEN}#$TASK_NUMBER${NC}"
            
            # Show task details if gh is available
            if command -v gh &> /dev/null; then
                TASK_TITLE=$(gh issue view "$TASK_NUMBER" --json title --jq '.title' 2>/dev/null || echo "")
                if [ -n "$TASK_TITLE" ]; then
                    echo -e "   ${BLUE}$TASK_TITLE${NC}"
                fi
            fi
        else
            echo -e "${YELLOW}‚ö†Ô∏è  No task linked to this feature${NC}"
            echo -e "${BLUE}Link a task with:${NC}"
            echo -e "  ${GREEN}./tools/github-project-management/utilities/get-next-kanban-item.sh --auto-assign${NC}"
        fi
        
        # Check feature status
        if [ -f ".claude/gitflow-status.env" ]; then
            source .claude/gitflow-status.env
            echo -e "\n${PURPLE}Feature Status:${NC}"
            echo -e "  Started: $GITFLOW_STARTED_AT"
            echo -e "  Commits: $GITFLOW_COMMIT_COUNT"
            
            # Show time since last commit
            if [ -n "$GITFLOW_LAST_COMMIT" ]; then
                LAST_COMMIT_TS=$(date -j -f "%Y-%m-%dT%H:%M:%SZ" "$GITFLOW_LAST_COMMIT" +%s 2>/dev/null || date -d "$GITFLOW_LAST_COMMIT" +%s 2>/dev/null)
                NOW_TS=$(date +%s)
                HOURS_SINCE=$((($NOW_TS - $LAST_COMMIT_TS) / 3600))
                
                if [ $HOURS_SINCE -gt 24 ]; then
                    DAYS_SINCE=$((HOURS_SINCE / 24))
                    echo -e "  Last commit: ${YELLOW}$DAYS_SINCE days ago${NC}"
                    echo -e "${YELLOW}‚ö†Ô∏è  Feature might be stale. Consider finishing or updating.${NC}"
                else
                    echo -e "  Last commit: ${GREEN}$HOURS_SINCE hours ago${NC}"
                fi
            fi
        fi
        
        echo -e "\n${BLUE}What to do:${NC}"
        echo -e "  1. Continue development"
        echo -e "  2. Push changes: ${GREEN}git push${NC}"
        echo -e "  3. Create PR: ${GREEN}gh pr create${NC}"
        echo -e "  4. Finish feature: ${GREEN}git flow feature finish $FEATURE_NAME${NC}"
        
    elif [[ "$NEW_BRANCH" =~ ^release/ ]]; then
        echo -e "üöÄ Now on release branch"
        echo -e "${YELLOW}Only bug fixes allowed!${NC}"
        echo -e "${BLUE}When ready:${NC} ${GREEN}git flow release finish${NC}"
        
    elif [[ "$NEW_BRANCH" =~ ^hotfix/ ]]; then
        echo -e "üî• Now on hotfix branch"
        echo -e "${RED}Fix critical issues only!${NC}"
        echo -e "${BLUE}When ready:${NC} ${GREEN}git flow hotfix finish${NC}"
        
    else
        echo -e "\n${RED}‚ö†Ô∏è  WARNING: Non-GitFlow branch detected!${NC}"
        echo -e "${YELLOW}Branch '$NEW_BRANCH' doesn't follow GitFlow conventions.${NC}"
        echo -e "\n${BLUE}GitFlow branch prefixes:${NC}"
        echo -e "  ‚Ä¢ ${GREEN}feature/${NC} - New features"
        echo -e "  ‚Ä¢ ${GREEN}release/${NC} - Release preparation"
        echo -e "  ‚Ä¢ ${GREEN}hotfix/${NC} - Emergency fixes"
        echo -e "  ‚Ä¢ ${GREEN}bugfix/${NC} - Non-emergency bug fixes"
        echo -e "\n${RED}Consider switching to a proper GitFlow branch!${NC}"
    fi
    
    # Kanban reminders
    echo -e "\n${PURPLE}üìä Kanban Reminders:${NC}"
    
    # Check current work status
    if [ -f "./tools/github-project-management/utilities/get-next-kanban-item.sh" ]; then
        echo -e "${BLUE}Check your work:${NC}"
        echo -e "  ‚Ä¢ Current WIP: ${GREEN}git wip${NC}"
        echo -e "  ‚Ä¢ Get next task: ${GREEN}git next${NC}"
        echo -e "  ‚Ä¢ Workflow status: ${GREEN}git workflow${NC}"
        
        # If switching TO a feature branch, suggest checking related tasks
        if [[ "$NEW_BRANCH" =~ ^feature/ ]] && [ ! -f ".claude/current-task.txt" ]; then
            echo -e "\n${YELLOW}üí° Tip:${NC} This feature has no linked task"
            echo -e "Run ${GREEN}git next${NC} to get a task from the backlog"
        fi
    fi
    
    # Check for uncommitted changes warning
    if ! git diff-index --quiet HEAD -- 2>/dev/null; then
        echo -e "\n${YELLOW}‚ö†Ô∏è  Warning: You have uncommitted changes!${NC}"
        echo -e "Run ${GREEN}git status${NC} to see what's modified"
    fi
    
    # Time tracking reminder
    if [[ "$NEW_BRANCH" =~ ^feature/ ]]; then
        echo -e "\n${BLUE}‚è±Ô∏è  Time tracking active for this feature${NC}"
    fi
    
    echo -e "\n${GREEN}Ready to work! üöÄ${NC}\n"
fi